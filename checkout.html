<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
.box{background:#fff;margin:20px;padding:20px;border-radius:16px}
.item{display:flex;justify-content:space-between;margin-bottom:8px}
.total{font-weight:bold;margin-top:10px}
input,select,button{width:100%;padding:12px;margin-top:10px;border-radius:8px}
button{background:#27ae60;color:#fff;border:none}
.batal{background:#e74c3c}
.status{margin-top:15px;font-weight:bold}
</style>
</head>

<body>

<div class="box">
  <h3>Pesanan</h3>
  <div id="cartList"></div>
  <div class="total" id="totalHarga"></div>
  <div id="aksiPesanan"></div>
</div>

<div class="box">
  <h3>Alamat Pengiriman</h3>
  <input id="nama" placeholder="Nama Penerima">
  <input id="alamat" placeholder="Alamat Lengkap">
  <input id="hp" placeholder="No HP">
</div>

<div class="box">
  <h3>Pembayaran</h3>
  <select id="bank">
    <option value="">Pilih Metode</option>
    <option value="BCA">BCA</option>
    <option value="BRI">BRI</option>
    <option value="DANA">DANA</option>
    <option value="OVO">OVO</option>
  </select>
  <div class="status" id="statusBayar"></div>
</div>

<!-- ‚úÖ MIDTRANS CLIENT KEY (WAJIB DI CHECKOUT.HTML) -->
<script src="https://app.midtrans.com/snap/snap.js"
data-client-key="Mid-client-L5qvKZPZDD2WV6lZ"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDGtaYv3aoWCgIgRfolj8vsOcihKCVc39k",
  authDomain: "kampung-parakanceuri.firebaseapp.com",
  projectId: "kampung-parakanceuri"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üõí CART */
const cart = JSON.parse(localStorage.getItem("cart")) || [];
const list = document.getElementById("cartList");
const totalEl = document.getElementById("totalHarga");
const aksiEl = document.getElementById("aksiPesanan");
const statusEl = document.getElementById("statusBayar");

let subtotal = 0;
const ongkir = 15000;

cart.forEach(i=>{
  const sub = i.harga * i.qty;
  subtotal += sub;
  list.innerHTML += `
    <div class="item">
      <span>${i.nama} x ${i.qty}</span>
      <span>Rp ${sub.toLocaleString("id-ID")}</span>
    </div>
  `;
});

const totalBayar = subtotal + ongkir;
totalEl.innerHTML = `
Subtotal: Rp ${subtotal.toLocaleString("id-ID")}<br>
Ongkir: Rp ${ongkir.toLocaleString("id-ID")}<br>
<b>Total: Rp ${totalBayar.toLocaleString("id-ID")}</b>
`;

/* üîò TOMBOL */
aksiEl.innerHTML = `
<button onclick="bayar()">Bayar Sekarang</button>
<button class="batal" onclick="batalkan()">Batalkan Pesanan</button>
`;

/* üí∞ BAYAR (SIMULASI SNAP) */
window.bayar = async () => {
  const nama = nama.value;
  const alamat = document.getElementById("alamat").value;
  const hp = document.getElementById("hp").value;
  const bank = document.getElementById("bank").value;

  if(!nama || !alamat || !hp || !bank){
    alert("Lengkapi data terlebih dahulu");
    return;
  }

  statusEl.innerHTML = "‚è≥ Membuka pembayaran Midtrans...";

  await addDoc(collection(db,"orders"),{
    nama, alamat, hp, bank,
    items: cart,
    subtotal, ongkir, total: totalBayar,
    status: "MENUNGGU PEMBAYARAN",
    waktu: serverTimestamp()
  });

  alert("Snap Midtrans akan muncul di tahap backend token (Firebase Function)");
};

/* ‚ùå BATAL */
window.batalkan = () => {
  localStorage.removeItem("cart");
  list.innerHTML="";
  aksiEl.innerHTML="";
  statusEl.innerHTML="‚ùå Pesanan dibatalkan";
};
</script>

</body>
</html>
